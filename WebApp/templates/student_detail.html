<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic HTML</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Overzicht student</h1>
        <table id="studentTable" border="1">
            <thead>
                <tr>
                    <th>Naam</th>
                    <th>Studentnummer</th>
                    <th>Klas</th>
                    <th>Action Type</th>
                    <th>Datum ingevuld</th>
                    <th>Team</th>
                    <th>Ingedeeld door</th>
                </tr>
            </thead>
            <tbody>
                <!-- De tabelrijen worden hier toegevoegd -->
            </tbody>
        </table>
        <button id="adjust-btn" title="adjust">Wijzig gegevens</button>
        
    
    
    
        <p>Gekozen stellingen:</p>
    <table id="statementTable" border="1">
        <thead>
            <tr>
                <th>Stellingen</th>
            </tr>
        </thead>
        <tbody>
            <!-- De tabelrijen worden hier toegevoegd -->
        </tbody>
    </table>

   

    <!-- Somewhere in your body -->
    <input type="hidden" id="student-number" value="{{ student_number }}">


<script>
    
    
     $(document).ready(function() {
            console.log('Document ready');
            let studentNumber = $('#student-number').val();
            console.log('Student number:', studentNumber);
            const baseUrl = window.location.origin;
            const choicesUrl = `${baseUrl}/teacher/get_student_choices/${studentNumber}`;
            const studentInfoUrl = `${baseUrl}/teacher/get_student_info_specific_student/${studentNumber}`;

            function populateStatementTable() {
                $.ajax({
                    url: choicesUrl, // Flask endpoint that returns the statement data
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log(data);
                        const statementTableBody = $('#statementTable tbody');
                        statementTableBody.empty();  // Maak de tabelbody leeg voordat je nieuwe rijen toevoegt
                        data.forEach(function(statement) {
                            console.log(statement.text);
                            const tableRow = `
                                <tr>
                                    <td>${statement.text}</td>
                                </tr>
                            `;
                            statementTableBody.append(tableRow);
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching data:', error);
                    }
                });
            }

            function populateStudentTable() {  // Correct function name
                $.ajax({
                    url: studentInfoUrl, // Flask endpoint that returns the student info data
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log(data);
                        const studentTableBody = $('#studentTable tbody');
                        studentTableBody.empty();  // Maak de tabelbody leeg voordat je nieuwe rijen toevoegt
                        data.forEach(function(student) {
                            const teamName = student.team_name === 'No Team' ? "Nog niet ingedeeld" : student.team_name;
                            const teacherName = student.teacher_name === 'No Teacher' ? "Nog niet ingedeeld" : student.teacher_name;
                            console.log(student.student_name);
                            const tableRow = `
                                <tr>
                                    <td>${student.student_name}</td>
                                    <td>${student.student_number}</td>
                                    <td>${student.student_class}</td>
                                    <td>${student.action_type}</td>
                                    <td>${student.action_date}</td>
                                    <td>${teamName}</td>
                                    <td>${teacherName}</td>
                                </tr>
                            `;
                            studentTableBody.append(tableRow);
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching data:', error);
                    }
                });
            }

        function setupEventListeners() {
        // Function for the adjust button
        $('#adjust-btn').click(function() {
            // Control the button state and functionality
            if ($(this).text() === 'Wijzig gegevens') {
                $('#studentTable tbody tr').each(function() {
                    // Maak alle velden in de rij bewerkbaar behalve het studentnummer en de datum
                    $(this).find('td').each(function(index) {
                        if (index === 0 || index === 2 || index === 3 || index === 5) {
                            $(this).attr('contenteditable', 'true').css('background-color', '#f0f0f0');
                        }
                    });
                });

                // Verander de tekst van de knop naar "Opslaan"
                $(this).text('Opslaan').attr('id', 'save-btn');
            } else {
                // Opslaan als de knoptekst "Opslaan" is
                $('#studentTable tbody tr').each(function() {
                    const studentName = $(this).find('td').eq(0).text();
                    const studentClass = $(this).find('td').eq(2).text();
                    const actionType = $(this).find('td').eq(3).text();
                    const teamName = $(this).find('td').eq(5).text();
                    const teacherName = $(this).find('td').eq(6).text();

                    console.log(`Name: ${studentName}, Class: ${studentClass}, Action Type: ${actionType}, Team: ${teamName}, Teacher: ${teacherName}`);

                    // Voeg hier de AJAX-aanroep toe om de gewijzigde gegevens naar de server te sturen.
                    $.ajax({
                        url: `${baseUrl}/teacher/update_student_info`,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            student_number: studentNumber,
                            name: studentName,
                            student_class: studentClass,
                            action_type: actionType,
                            team_name: teamName,
                            teacher_name: teacherName
                        }),
                        success: function(response) {
                            alert('Studentgegevens succesvol bijgewerkt');
                            populateStudentTable();  // Update the student table with the new data
                            // Velden niet meer bewerkbaar maken en kleur resetten
                            $('#studentTable tbody tr td[contenteditable="true"]').each(function() {
                                $(this).removeAttr('contenteditable').css('background-color', '');
                            });

                            // Verander de knoptekst terug naar "Wijzig gegevens"
                            $('#save-btn').text('Wijzig gegevens').attr('id', 'adjust-btn');
                        },
                        error: function(xhr, status, error) {
                            console.error('Error bij het bijwerken van de gegevens:', error);
                        }
                    });
                });
            }
        });
    }

            populateStatementTable();  // Call function to populate statements table
            populateStudentTable();    // Call function to populate student info table
            setupEventListeners();     // Set up event listeners
        });
        
    



</script>
    
    
</body>
</html>